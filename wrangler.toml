# ğŸŒ Cloudflare Workersè¨­å®š
# OpenNext + Next.js ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­å®š

name = "crypto-ai-platform"
main = ".next/standalone/server.js"
compatibility_date = "2024-07-19"
compatibility_flags = ["nodejs_compat"]

# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
account_id = "$CLOUDFLARE_ACCOUNT_ID"
workers_dev = true

# KV ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
[[kv_namespaces]]
binding = "CACHE"
id = "$KV_CACHE_NAMESPACE_ID"
preview_id = "$KV_CACHE_PREVIEW_ID"

[[kv_namespaces]]
binding = "SESSIONS"
id = "$KV_SESSIONS_NAMESPACE_ID"
preview_id = "$KV_SESSIONS_PREVIEW_ID"

# R2 ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆé™çš„ã‚¢ã‚»ãƒƒãƒˆï¼‰
[[r2_buckets]]
binding = "ASSETS"
bucket_name = "$R2_ASSETS_BUCKET"
preview_bucket_name = "$R2_ASSETS_PREVIEW_BUCKET"

# D1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
[[d1_databases]]
binding = "DB"
database_name = "crypto-ai-platform-cache"
database_id = "$D1_DATABASE_ID"

# ç’°å¢ƒå¤‰æ•°
[env.production.vars]
NODE_ENV = "production"
NEXT_PUBLIC_APP_URL = "https://crypto-ai-platform.workers.dev"
ENVIRONMENT = "production"

# Supabaseè¨­å®š
NEXT_PUBLIC_SUPABASE_URL = "$SUPABASE_URL"
NEXT_PUBLIC_SUPABASE_ANON_KEY = "$SUPABASE_ANON_KEY"
SUPABASE_SERVICE_KEY = "$SUPABASE_SERVICE_KEY"

# OpenAIè¨­å®š
OPENAI_API_KEY = "$OPENAI_API_KEY"

# Anthropicè¨­å®š
ANTHROPIC_API_KEY = "$ANTHROPIC_API_KEY"

# Stripeè¨­å®š
STRIPE_SECRET_KEY = "$STRIPE_SECRET_KEY"
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "$STRIPE_PUBLISHABLE_KEY"
STRIPE_WEBHOOK_SECRET = "$STRIPE_WEBHOOK_SECRET"

# CoinMarketCapè¨­å®š
COINMARKETCAP_API_KEY = "$COINMARKETCAP_API_KEY"

# Sentryè¨­å®š
SENTRY_DSN = "$SENTRY_DSN"

[env.staging.vars]
NODE_ENV = "staging"
NEXT_PUBLIC_APP_URL = "https://staging.crypto-ai-platform.workers.dev"
ENVIRONMENT = "staging"

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
NEXT_PUBLIC_SUPABASE_URL = "$SUPABASE_STAGING_URL"
NEXT_PUBLIC_SUPABASE_ANON_KEY = "$SUPABASE_STAGING_ANON_KEY"
SUPABASE_SERVICE_KEY = "$SUPABASE_STAGING_SERVICE_KEY"

[env.development.vars]
NODE_ENV = "development"
NEXT_PUBLIC_APP_URL = "http://localhost:3000"
ENVIRONMENT = "development"

# ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
[limits]
cpu_ms = 30000           # CPUæ™‚é–“åˆ¶é™ï¼ˆ30ç§’ï¼‰
memory_mb = 512          # ãƒ¡ãƒ¢ãƒªåˆ¶é™ï¼ˆ512MBï¼‰

# ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆåˆ¶é™
[rate_limiting]
enabled = true
requests_per_minute = 1000
burst_size = 50

# Workers AIè¨­å®š
[ai]
binding = "AI"

# Analytics Engineè¨­å®š
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "crypto_ai_platform_analytics"

# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
[[routes]]
pattern = "crypto-ai-platform.workers.dev/*"
zone_name = "workers.dev"

[[routes]]
pattern = "api.crypto-ai-platform.com/*"
zone_name = "crypto-ai-platform.com"
custom_domain = true

# é™çš„ã‚¢ã‚»ãƒƒãƒˆè¨­å®š
[site]
bucket = ".next/static"
include = ["**/*"]
exclude = ["*.map", "node_modules/**/*"]

# ãƒŸãƒ‹ãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
[minify]
javascript = true
css = true
html = true

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
[cache]
browser_ttl = 86400      # 1æ—¥
edge_ttl = 604800        # 1é€±é–“
always_online = true

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
[security]
csrf_protection = true
content_security_policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co https://api.openai.com https://api.anthropic.com https://api.stripe.com; frame-src https://js.stripe.com;"

# ãƒ­ã‚°è¨­å®š
[observability]
enabled = true
head_sampling = 0.01     # 1%ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°

# Cron Triggersï¼ˆå®šæœŸå®Ÿè¡Œï¼‰
[[triggers]]
crons = ["0 */6 * * *"]  # 6æ™‚é–“ã”ã¨