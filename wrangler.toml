# 🌐 Cloudflare Workers設定
# OpenNext + Next.js デプロイメント設定

name = "crypto-ai-platform"
main = ".next/standalone/server.js"
compatibility_date = "2024-07-19"
compatibility_flags = ["nodejs_compat"]

# アカウント設定
account_id = "$CLOUDFLARE_ACCOUNT_ID"
workers_dev = true

# KV ストレージ
[[kv_namespaces]]
binding = "CACHE"
id = "$KV_CACHE_NAMESPACE_ID"
preview_id = "$KV_CACHE_PREVIEW_ID"

[[kv_namespaces]]
binding = "SESSIONS"
id = "$KV_SESSIONS_NAMESPACE_ID"
preview_id = "$KV_SESSIONS_PREVIEW_ID"

# R2 ストレージ（静的アセット）
[[r2_buckets]]
binding = "ASSETS"
bucket_name = "$R2_ASSETS_BUCKET"
preview_bucket_name = "$R2_ASSETS_PREVIEW_BUCKET"

# D1 データベース（キャッシュ用）
[[d1_databases]]
binding = "DB"
database_name = "crypto-ai-platform-cache"
database_id = "$D1_DATABASE_ID"

# 環境変数
[env.production.vars]
NODE_ENV = "production"
NEXT_PUBLIC_APP_URL = "https://crypto-ai-platform.workers.dev"
ENVIRONMENT = "production"

# Supabase設定
NEXT_PUBLIC_SUPABASE_URL = "$SUPABASE_URL"
NEXT_PUBLIC_SUPABASE_ANON_KEY = "$SUPABASE_ANON_KEY"
SUPABASE_SERVICE_KEY = "$SUPABASE_SERVICE_KEY"

# OpenAI設定
OPENAI_API_KEY = "$OPENAI_API_KEY"

# Anthropic設定
ANTHROPIC_API_KEY = "$ANTHROPIC_API_KEY"

# Stripe設定
STRIPE_SECRET_KEY = "$STRIPE_SECRET_KEY"
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "$STRIPE_PUBLISHABLE_KEY"
STRIPE_WEBHOOK_SECRET = "$STRIPE_WEBHOOK_SECRET"

# CoinMarketCap設定
COINMARKETCAP_API_KEY = "$COINMARKETCAP_API_KEY"

# Sentry設定
SENTRY_DSN = "$SENTRY_DSN"

[env.staging.vars]
NODE_ENV = "staging"
NEXT_PUBLIC_APP_URL = "https://staging.crypto-ai-platform.workers.dev"
ENVIRONMENT = "staging"

# ステージング用データベース
NEXT_PUBLIC_SUPABASE_URL = "$SUPABASE_STAGING_URL"
NEXT_PUBLIC_SUPABASE_ANON_KEY = "$SUPABASE_STAGING_ANON_KEY"
SUPABASE_SERVICE_KEY = "$SUPABASE_STAGING_SERVICE_KEY"

[env.development.vars]
NODE_ENV = "development"
NEXT_PUBLIC_APP_URL = "http://localhost:3000"
ENVIRONMENT = "development"

# リソース制限
[limits]
cpu_ms = 30000           # CPU時間制限（30秒）
memory_mb = 512          # メモリ制限（512MB）

# リクエストレート制限
[rate_limiting]
enabled = true
requests_per_minute = 1000
burst_size = 50

# Workers AI設定
[ai]
binding = "AI"

# Analytics Engine設定
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "crypto_ai_platform_analytics"

# ルーティング設定
[[routes]]
pattern = "crypto-ai-platform.workers.dev/*"
zone_name = "workers.dev"

[[routes]]
pattern = "api.crypto-ai-platform.com/*"
zone_name = "crypto-ai-platform.com"
custom_domain = true

# 静的アセット設定
[site]
bucket = ".next/static"
include = ["**/*"]
exclude = ["*.map", "node_modules/**/*"]

# ミニフィケーション設定
[minify]
javascript = true
css = true
html = true

# キャッシュ設定
[cache]
browser_ttl = 86400      # 1日
edge_ttl = 604800        # 1週間
always_online = true

# セキュリティヘッダー
[security]
csrf_protection = true
content_security_policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co https://api.openai.com https://api.anthropic.com https://api.stripe.com; frame-src https://js.stripe.com;"

# ログ設定
[observability]
enabled = true
head_sampling = 0.01     # 1%サンプリング

# Cron Triggers（定期実行）
[[triggers]]
crons = ["0 */6 * * *"]  # 6時間ごと