// ğŸ”§ Next.jsè¨­å®š - Cloudflare Workersæœ€é©åŒ–
// OpenNext + Edge Runtimeå¯¾å¿œ

/** @type {import('next').NextConfig} */
const nextConfig = {
  // å‡ºåŠ›è¨­å®š
  output: 'standalone',
  
  // Edge Runtimeè¨­å®š
  experimental: {
    forceSwcTransforms: true
  },
  
  // ç”»åƒæœ€é©åŒ–ï¼ˆCloudflare Imagesä½¿ç”¨ï¼‰
  images: {
    loader: 'custom',
    loaderFile: './src/lib/cloudflare/image-loader.ts',
    domains: [
      'imagedelivery.net', // Cloudflare Images
      'supabase.co',
      'avatars.githubusercontent.com'
    ],
    formats: ['image/webp', 'image/avif'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384]
  },
  
  // å›½éš›åŒ–è¨­å®šï¼ˆApp Routerã§ã¯éå¯¾å¿œã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
  // i18n: {
  //   locales: ['ja', 'en'],
  //   defaultLocale: 'ja',
  //   domains: [
  //     {
  //       domain: 'crypto-ai-platform.com',
  //       defaultLocale: 'ja'
  //     },
  //     {
  //       domain: 'en.crypto-ai-platform.com',
  //       defaultLocale: 'en'
  //     }
  //   ]
  // },
  
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin'
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()'
          }
        ]
      },
      {
        source: '/api/(.*)',
        headers: [
          {
            key: 'Access-Control-Allow-Origin',
            value: process.env.NODE_ENV === 'production' 
              ? 'https://crypto-ai-platform.workers.dev'
              : 'http://localhost:3000'
          },
          {
            key: 'Access-Control-Allow-Methods',
            value: 'GET, POST, PUT, DELETE, OPTIONS'
          },
          {
            key: 'Access-Control-Allow-Headers',
            value: 'Content-Type, Authorization, X-Requested-With'
          }
        ]
      }
    ];
  },
  
  // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š
  async redirects() {
    return [
      {
        source: '/dashboard',
        destination: '/dashboard/overview',
        permanent: false
      },
      {
        source: '/learning',
        destination: '/learning/categories',
        permanent: false
      },
      {
        source: '/market',
        destination: '/market/overview',
        permanent: false
      }
    ];
  },
  
  // ãƒªãƒ©ã‚¤ãƒˆè¨­å®š
  async rewrites() {
    return [
      // API ãƒ—ãƒ­ã‚­ã‚·
      {
        source: '/api/proxy/coinmarketcap/:path*',
        destination: 'https://pro-api.coinmarketcap.com/:path*'
      },
      // å¥åº·ãƒã‚§ãƒƒã‚¯
      {
        source: '/health',
        destination: '/api/health'
      }
    ];
  },
  
  // Webpackè¨­å®š
  webpack: (config, { buildId, dev, isServer, defaultLoaders, webpack }) => {
    // Cloudflare Workerså‘ã‘æœ€é©åŒ–
    if (!isServer) {
      config.resolve.fallback = {
        ...config.resolve.fallback,
        fs: false,
        net: false,
        tls: false,
        crypto: require.resolve('crypto-browserify'),
        stream: require.resolve('stream-browserify'),
        util: require.resolve('util'),
        buffer: require.resolve('buffer'),
        process: require.resolve('process/browser')
      };
    }
    
    // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¿½åŠ 
    config.plugins.push(
      new webpack.ProvidePlugin({
        Buffer: ['buffer', 'Buffer'],
        process: 'process'
      })
    );
    
    // ãƒãƒ³ãƒ‰ãƒ«åˆ†æï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
    if (dev && process.env.ANALYZE === 'true') {
      const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer');
      config.plugins.push(
        new BundleAnalyzerPlugin({
          analyzerMode: 'server',
          openAnalyzer: true
        })
      );
    }
    
    // Tree shakingæœ€é©åŒ–
    if (!dev) {
      config.optimization = {
        ...config.optimization,
        usedExports: true,
        sideEffects: false
      };
    }
    
    return config;
  },
  
  // ç’°å¢ƒå¤‰æ•°
  env: {
    CUSTOM_KEY: 'crypto-ai-platform',
    BUILD_TIME: new Date().toISOString(),
    COMMIT_SHA: process.env.GITHUB_SHA || 'development'
  },
  
  // å…¬é–‹ç’°å¢ƒå¤‰æ•°
  publicRuntimeConfig: {
    staticFolder: '/static'
  },
  
  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ç’°å¢ƒå¤‰æ•°
  serverRuntimeConfig: {
    PROJECT_ROOT: __dirname
  },
  
  // å‹ãƒã‚§ãƒƒã‚¯è¨­å®š
  typescript: {
    // æœ¬ç•ªãƒ“ãƒ«ãƒ‰æ™‚ã¯å‹ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆCI/CDã§å®Ÿè¡Œæ¸ˆã¿ï¼‰
    ignoreBuildErrors: process.env.NODE_ENV === 'production'
  },
  
  // ESLintè¨­å®š
  eslint: {
    // æœ¬ç•ªãƒ“ãƒ«ãƒ‰æ™‚ã¯ESLintã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆCI/CDã§å®Ÿè¡Œæ¸ˆã¿ï¼‰
    ignoreDuringBuilds: process.env.NODE_ENV === 'production'
  },
  
  // SWCè¨­å®š
  // swcMinify: true, // Next.js 15ã§ã¯éæ¨å¥¨
  
  // åœ§ç¸®è¨­å®š
  compress: true,
  
  // PoweredBy ãƒ˜ãƒƒãƒ€ãƒ¼ç„¡åŠ¹åŒ–
  poweredByHeader: false,
  
  // å³æ ¼ãƒ¢ãƒ¼ãƒ‰
  reactStrictMode: true,
  
  // ãƒˆãƒ¬ã‚¤ãƒ«ãƒ»ã‚¹ãƒ©ãƒƒã‚·ãƒ¥
  trailingSlash: false,
  
  // ãƒ©ãƒ³ã‚¿ã‚¤ãƒ è¨­å®šï¼ˆéæ¨å¥¨ã®ãŸã‚å‰Šé™¤ï¼‰
  // runtime: 'experimental-edge',
  
  // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
  logging: {
    fetches: {
      fullUrl: process.env.NODE_ENV === 'development'
    }
  },
  
  // æœ€é©åŒ–è¨­å®š
  compiler: {
    // Emotion CSS-in-JSæœ€é©åŒ–
    emotion: true,
    
    // styled-componentsæœ€é©åŒ–
    styledComponents: true,
    
    // Reactæœ€é©åŒ–
    reactRemoveProperties: process.env.NODE_ENV === 'production',
    
    // console.logå‰Šé™¤ï¼ˆæœ¬ç•ªã®ã¿ï¼‰
    removeConsole: process.env.NODE_ENV === 'production' ? {
      exclude: ['error', 'warn']
    } : false
  },
  
  // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¢ƒç•Œè¨­å®š
  modularizeImports: {
    lodash: {
      transform: 'lodash/{{member}}'
    }
  },
  
  // å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æœ€é©åŒ–
  transpilePackages: [
    '@supabase/auth-helpers-nextjs',
    '@supabase/auth-helpers-shared'
  ]
};

// è¿½åŠ è¨­å®šï¼ˆç’°å¢ƒåˆ¥ï¼‰
if (process.env.NODE_ENV === 'development') {
  // é–‹ç™ºç’°å¢ƒå›ºæœ‰è¨­å®š
  nextConfig.experimental = {
    ...nextConfig.experimental,
    forceSwcTransforms: true
  };
}

if (process.env.NODE_ENV === 'production') {
  // æœ¬ç•ªç’°å¢ƒå›ºæœ‰è¨­å®š
  nextConfig.experimental = {
    ...nextConfig.experimental,
    optimizeCss: true,
    optimizePackageImports: [
      'lucide-react',
      '@radix-ui/react-icons'
    ]
  };
}

// Cloudflare Workerså‘ã‘è¿½åŠ è¨­å®š
if (process.env.DEPLOY_TARGET === 'cloudflare') {
  nextConfig.experimental = {
    ...nextConfig.experimental,
    esmExternals: true,
    serverMinification: true
  };
  
  // Edge Runtimeå¼·åˆ¶
  nextConfig.experimental.runtime = 'edge';
}

module.exports = nextConfig;