# ğŸš€ Cloudflare Workers CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# OpenNext + Next.js è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»å“è³ªãƒã‚§ãƒƒã‚¯
  test:
    name: ãƒ†ã‚¹ãƒˆ & å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
        
      - name: TypeScript å‹ãƒã‚§ãƒƒã‚¯
        run: npm run type-check
        
      - name: ESLint ãƒã‚§ãƒƒã‚¯ (warnings tolerated)
        run: npm run lint -- --max-warnings=500
        
      - name: Unit ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: npm run test:unit
        if: false # ã¾ã å®Ÿè£…ã—ã¦ã„ãªã„å ´åˆ
        
      - name: E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: npm run test:e2e
        if: false # ã¾ã å®Ÿè£…ã—ã¦ã„ãªã„å ´åˆ
        
      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
        run: npm audit --audit-level=high
        
      - name: ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        run: |
          npm run build
          npx bundlesize

  # ğŸ”§ ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™
  build:
    name: ãƒ“ãƒ«ãƒ‰ & OpenNextå¤‰æ›
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
        
      - name: ç’°å¢ƒå¤‰æ•°è¨­å®š
        run: |
          echo "NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}" >> $GITHUB_ENV
          echo "NODE_ENV=production" >> $GITHUB_ENV
          
      - name: Next.js ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          
      - name: OpenNextå¤‰æ›
        run: npx open-next build
        
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            .open-next/
          retention-days: 1

  # ğŸŒ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-staging:
    name: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          
      - name: Wrangler ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: KV ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ç¢ºèª
        run: |
          wrangler kv:namespace list | grep -q "crypto-ai-staging-cache" || \
          wrangler kv:namespace create "crypto-ai-staging-cache"
          
      - name: ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰
        run: |
          echo "${{ secrets.SUPABASE_STAGING_SERVICE_KEY }}" | wrangler secret put SUPABASE_SERVICE_KEY --env staging
          echo "${{ secrets.OPENAI_API_KEY }}" | wrangler secret put OPENAI_API_KEY --env staging
          echo "${{ secrets.STRIPE_TEST_SECRET_KEY }}" | wrangler secret put STRIPE_SECRET_KEY --env staging
          
      - name: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        run: wrangler deploy --env staging
        
      - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        run: |
          sleep 10
          curl -f ${{ secrets.STAGING_APP_URL }}/api/health || exit 1
          
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: |
            ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒ${{ job.status == 'success' && 'æˆåŠŸ' || 'å¤±æ•—' }}ã—ã¾ã—ãŸ
            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}
            ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}

  # ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-production:
    name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          
      - name: Wrangler ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: æœ¬ç•ªå‰ãƒã‚§ãƒƒã‚¯
        run: |
          # é‡è¦ãªç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ç¢ºèª
          test -n "${{ secrets.SUPABASE_SERVICE_KEY }}"
          test -n "${{ secrets.STRIPE_SECRET_KEY }}"
          test -n "${{ secrets.OPENAI_API_KEY }}"
          
      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        run: |
          # Supabase ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          npx supabase db push --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        if: false # å¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–
        
      - name: ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆæœ¬ç•ªï¼‰
        run: |
          echo "${{ secrets.SUPABASE_SERVICE_KEY }}" | wrangler secret put SUPABASE_SERVICE_KEY --env production
          echo "${{ secrets.OPENAI_API_KEY }}" | wrangler secret put OPENAI_API_KEY --env production
          echo "${{ secrets.ANTHROPIC_API_KEY }}" | wrangler secret put ANTHROPIC_API_KEY --env production
          echo "${{ secrets.STRIPE_SECRET_KEY }}" | wrangler secret put STRIPE_SECRET_KEY --env production
          echo "${{ secrets.STRIPE_WEBHOOK_SECRET }}" | wrangler secret put STRIPE_WEBHOOK_SECRET --env production
          echo "${{ secrets.COINMARKETCAP_API_KEY }}" | wrangler secret put COINMARKETCAP_API_KEY --env production
          echo "${{ secrets.SENTRY_DSN }}" | wrangler secret put SENTRY_DSN --env production
          
      - name: æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
        run: wrangler deploy --env production
        
      - name: ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
        run: |
          wrangler route add "${{ secrets.CUSTOM_DOMAIN }}/*" crypto-ai-platform --env production
        if: ${{ secrets.CUSTOM_DOMAIN }}
        
      - name: æœ¬ç•ªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        run: |
          sleep 15
          curl -f ${{ secrets.PRODUCTION_APP_URL }}/api/health || exit 1
          curl -f ${{ secrets.PRODUCTION_APP_URL }}/api/market/health || exit 1
          
      - name: Sentry ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: production
          version: ${{ github.sha }}
          
      - name: æˆåŠŸé€šçŸ¥
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: |
            ğŸ‰ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼
            
            ğŸ“± ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³: ${{ secrets.PRODUCTION_APP_URL }}
            ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: https://dash.cloudflare.com
            ğŸ” Sentry: https://sentry.io
            
            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}
            ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: ${{ steps.deploy.outputs.deployment-time }}

  # ğŸ”„ ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œå‡¦ç†
  post-deploy:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œå‡¦ç†
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
      - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
        run: |
          # é‡è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
          curl -s ${{ secrets.PRODUCTION_APP_URL }}/api/market/prices > /dev/null
          curl -s ${{ secrets.PRODUCTION_APP_URL }}/api/learning/categories > /dev/null
          curl -s ${{ secrets.PRODUCTION_APP_URL }}/learning > /dev/null
          
      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        run: |
          # Lighthouseãªã©ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
          npx lighthouse ${{ secrets.PRODUCTION_APP_URL }} --output=json --output-path=lighthouse.json
          
      - name: ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šæ›´æ–°
        run: |
          # Cloudflare Workers Analytics ã§ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
          echo "ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚’æ›´æ–°ä¸­..."
        if: false # å®Ÿè£…æ™‚ã«æœ‰åŠ¹åŒ–

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
security:
  permissions:
    contents: read
    deployments: write
    
  secrets:
    required:
      - CLOUDFLARE_API_TOKEN
      - CLOUDFLARE_ACCOUNT_ID
      - NEXT_PUBLIC_SUPABASE_URL
      - NEXT_PUBLIC_SUPABASE_ANON_KEY
      - SUPABASE_SERVICE_KEY
      - OPENAI_API_KEY
      - STRIPE_SECRET_KEY
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
